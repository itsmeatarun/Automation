<?xml version='1.0' encoding='UTF-8'?>
<workflow xmlns="http://vmware.com/vco/workflow" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://vmware.com/vco/workflow http://vmware.com/vco/workflow/Workflow-v4.xsd" root-name="item1" object-name="workflow:name=generic" id="370295ac-0d2b-48a9-a59a-c0083ae693e9" version="0.1.3" api-version="6.0.0" allowed-operations="evf" editor-version="2.0" restartMode="1" resumeFromFailedMode="0">
  <display-name><![CDATA[Get Access Token]]></display-name>
  <description><![CDATA[Returns access token based on username and password in configuration element, if existing access token is found, check age and uses if still valid.]]></description>
  <error-handler name="item7">
    <position y="150.0" x="80.0"/>
  </error-handler>
  <position y="65.0" x="50.0"/>
  <output>
    <param name="accessToken" type="string"/>
  </output>
  <attrib name="vraApiConfiguration" type="ConfigurationElement" read-only="false">
    <value encoded="n"><![CDATA[dunes://service.dunes.ch/ConfigurationElement?id='3c2e0092-6448-49f4-8b5f-eaea26743b0c'&dunesName='ConfigurationElement']]></value>
    <description><![CDATA[Configuration element with vRA API information]]></description>
  </attrib>
  <attrib name="maxTokenHours" type="number" read-only="false">
    <value encoded="n"><![CDATA[4.0]]></value>
    <description><![CDATA[Maximum age of token (in hours) before requesting new token.]]></description>
  </attrib>
  <attrib name="tokenExpired" type="boolean" read-only="false">
    <value encoded="n"><![CDATA[false]]></value>
    <description><![CDATA[Is token determined to be expired]]></description>
  </attrib>
  <attrib name="errorCode" type="string" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
  </attrib>
  <workflow-item name="item0" type="end" end-mode="0">
    <in-binding/>
    <position y="10.0" x="570.0"/>
  </workflow-item>
  <workflow-item name="item1" out-name="item3" type="task">
    <display-name><![CDATA[Check Token Age]]></display-name>
    <script encoded="false"><![CDATA[LockingSystem.lockAndWait(workflow.id, "AccessToken");

try {
    accessToken = vraApiConfiguration.getAttributeWithKey("accessToken").value;
    System.log("Existing access token found, checking if still valid.");
    var maxHoursInMs = maxTokenHours * 60 * 60 * 1000;
    var tokenIssued = vraApiConfiguration.getAttributeWithKey("accessTokenIssued").value;
    var currentDate = new Date;

    System.log("Existing Token Issued: " + System.formatDate(tokenIssued, "YYYY-MM-DD HH:mm:ss"));
    //Check difference between date issued and current date
    tokenExpired = (currentDate - tokenIssued) > maxHoursInMs;
} catch (e) {
    System.log("Access token not found, requesting token.");
    tokenExpired = true;
}
]]></script>
    <in-binding>
      <bind name="vraApiConfiguration" type="ConfigurationElement" export-name="vraApiConfiguration"/>
      <bind name="maxTokenHours" type="number" export-name="maxTokenHours"/>
    </in-binding>
    <out-binding>
      <bind name="accessToken" type="string" export-name="accessToken"/>
      <bind name="tokenExpired" type="boolean" export-name="tokenExpired"/>
    </out-binding>
    <description><![CDATA[Simple task with custom script capability.]]></description>
    <position y="75.0" x="141.0"/>
  </workflow-item>
  <workflow-item name="item2" type="end" end-mode="0">
    <in-binding/>
    <position y="65.0" x="570.0"/>
  </workflow-item>
  <workflow-item name="item3" out-name="item4" type="condition" alt-out-name="item5" comparator="0">
    <display-name><![CDATA[Token Expired?]]></display-name>
    <script encoded="false"><![CDATA[// Generated by the system, cannot be edited
return (tokenExpired === true);]]></script>
    <in-binding>
      <bind name="tokenExpired" type="boolean" export-name="tokenExpired"/>
    </in-binding>
    <out-binding/>
    <condition name="tokenExpired" type="boolean" comparator="0" label="null"/>
    <description><![CDATA[Custom decision based on a custom script.]]></description>
    <position y="65.0" x="270.0"/>
  </workflow-item>
  <workflow-item name="item4" out-name="item0" type="task">
    <display-name><![CDATA[Get Token]]></display-name>
    <script encoded="false"><![CDATA[const opMethod = "POST";
const opUrl = "/csp/gateway/am/api/login";
const contentType = "application/json";

var newTokenDate = new Date;
var contentJson = {
    "password": vraApiConfiguration.getAttributeWithKey("vraApiUserPassword").value,
    "username": vraApiConfiguration.getAttributeWithKey("vraApiUserName").value
}
var content = JSON.stringify(contentJson);
var vraBaseUrl = vraApiConfiguration.getAttributeWithKey("vraBaseUrl").value;
var opResponse = System.getModule("com.vmware.pso.rest").executeTransientRESTOperation(
    vraBaseUrl,null,null,opMethod,opUrl,null,null,contentType,content);

if (opResponse.statusCode >= 400) {
    throw "Failed to get access token (" + opResponse.statusCode + " Error). Details: " + opResponse.responseString;
}

var responseJson = JSON.parse(opResponse.responseString);
var accessToken = responseJson.cspAuthToken;

//Update configuration element with new access token and time stamp
vraApiConfiguration.setAttributeWithKey("accessToken", accessToken, "string");
vraApiConfiguration.setAttributeWithKey("accessTokenIssued", newTokenDate, "Date");

System.log("New token obtained, storing for future use.");
LockingSystem.unlock(workflow.id, "AccessToken");]]></script>
    <in-binding>
      <bind name="vraApiConfiguration" type="ConfigurationElement" export-name="vraApiConfiguration"/>
    </in-binding>
    <out-binding>
      <bind name="accessToken" type="string" export-name="accessToken"/>
    </out-binding>
    <description><![CDATA[Simple task with custom script capability.]]></description>
    <position y="20.0" x="400.0"/>
  </workflow-item>
  <workflow-item name="item5" out-name="item2" type="task">
    <display-name><![CDATA[Existing Token Found]]></display-name>
    <script encoded="false"><![CDATA[System.log("Existing token found and is still valid.");
LockingSystem.unlock(workflow.id, "AccessToken");]]></script>
    <in-binding/>
    <out-binding/>
    <description><![CDATA[Simple task with custom script capability.]]></description>
    <position y="75.0" x="400.0"/>
  </workflow-item>
  <workflow-item name="item6" throw-bind-name="errorCode" type="end" end-mode="1">
    <in-binding/>
    <position y="150.0" x="280.0"/>
  </workflow-item>
  <workflow-item name="item7" out-name="item6" type="task">
    <display-name><![CDATA[Default Unlock]]></display-name>
    <script encoded="false"><![CDATA[LockingSystem.unlock(workflow.id, "AccessToken");
System.warn("Exception thrown, unlocking workflow!");]]></script>
    <in-binding/>
    <out-binding/>
    <description><![CDATA[Simple task with custom script capability.]]></description>
    <position y="160.0" x="142.0"/>
  </workflow-item>
  <presentation/>
</workflow>